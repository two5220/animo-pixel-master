<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Animo Pixel Master - 제미나이 워터마크 제거 & 이미지 분할/압축 도구</title>
    <meta name="description" content="AI 워터마크 제거, 인스타그램용 이미지 분할, 고화질 용량 압축을 무료로 제공합니다. 서버 업로드 없는 안전한 클라이언트 사이드 이미지 처리 도구입니다.">
    <meta name="keywords" content="이미지 분할, 워터마크 제거, 제미나이, 사진 용량 줄이기, 인스타그램 그리드, 이미지 자르기, 무료 웹툴">
    <meta name="author" content="Animo">
    <meta property="og:title" content="Animo Pixel Master">
    <meta property="og:description" content="설치 없이 바로 쓰는 강력한 이미지 편집 도구. 워터마크 제거부터 분할 저장까지.">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#121212">
    <link rel="apple-touch-icon" href="icon.png"> 
    <link rel="manifest" href="manifest.json">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* [공통 변수] */
        :root { 
            --primary: #00e676; 
            --primary-dim: rgba(0, 230, 118, 0.1);
            --bg-dark: #121212; 
            --panel-bg: #1e1e1e; 
            --surface: #252525;
            --border: #333; 
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            --danger: #ff5252;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
            --gem-accent: #4285f4;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a3a2a 0%, #121212 60%);
            color: var(--text-main); 
            margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; padding-bottom: 50px;
        }
        
        /* 숫자 입력 화살표 제거 */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* [PC 전용 레이아웃: 1024px 이상] */
        @media (min-width: 1024px) {
            .container { max-width: 1400px !important; padding: 3rem !important; }
            .dashboard-layout { display: flex; gap: 25px; align-items: flex-start; margin-top: 20px; text-align: left; }
            .workspace-left { flex: 4; min-width: 0; }
            #previewContainer { height: 650px !important; margin-bottom: 0 !important; }
            .workspace-right { flex: 1; min-width: 280px; max-width: 340px; background: var(--surface); padding: 20px; border-radius: var(--radius-md); border: 1px solid var(--border); }
            
            .pc-tab-menu { display: flex !important; gap: 5px; margin-bottom: 15px; }
            .tab-btn { flex: 1; height: 60px !important; padding: 5px !important; line-height: 1.3 !important; white-space: pre-wrap !important; display: flex !important; justify-content: center; align-items: center; text-align: center; border-radius: 12px !important; }
            .pc-br { display: inline !important; }
            
            .pc-controls-wrapper { display: flex !important; gap: 15px; margin-bottom: 15px; padding: 15px; background: #181818; border-radius: 12px; border: 1px solid #333; }
            .btn-group-vertical { display: flex !important; flex-direction: column !important; gap: 8px !important; width: 45px; flex-shrink: 0; }
            
            .tab-attach { 
                width: 100% !important; 
                height: 40px !important; 
                border-radius: 8px !important; 
                font-size: 3rem !important; 
                line-height: 0.8 !important;
                margin: 0 !important; 
                display: flex !important; justify-content: center !important; align-items: center !important; 
                padding-bottom: 6px !important; 
            }
            .tab-delete { width: 100% !important; height: 40px !important; border-radius: 8px !important; font-size: 1rem !important; margin: 0 !important; }
            
            .chk-group-vertical { display: flex !important; flex-direction: column !important; justify-content: center; gap: 10px !important; align-items: flex-start !important; width: 100%; }
            
            #splitPanel, #cropPanel { grid-template-columns: 1fr 1fr !important; padding: 15px !important; background: rgba(0,0,0,0.2) !important; margin-bottom: 15px !important; }
            #splitPanel { grid-template-columns: 1fr 1fr 1fr !important; gap: 10px !important; }
            #splitPanel .input-group:nth-child(3) { grid-column: auto !important; }
            
            .ratio-select-wrapper { width: 100%; grid-column: span 2; position: relative; }
            .ratio-select { 
                width: 100%; padding: 12px; 
                padding-right: 30px; 
                background: #151515; color: #fff; border: 1px solid #333; border-radius: 10px; 
                font-size: 0.9rem; font-weight: bold; cursor: pointer; outline: none; 
                appearance: none; -webkit-appearance: none; -moz-appearance: none;
                text-align: center; 
                text-align-last: center; 
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 10px center; 
                background-size: 20px;
            }
            .ratio-select:hover { border-color: var(--primary); }
            
            .ratio-inputs-row { display: flex !important; gap: 10px !important; width: 100%; grid-column: span 2; margin-top: 5px !important; }
            .ratio-inputs-row input { flex: 1; text-align: center; }
            
            #splitPanel .input-group:last-child { grid-column: 1 / -1 !important; }
            #splitPanel .ratio-select-wrapper { grid-column: auto !important; width: 100%; }
            #splitPanel .ratio-inputs-row { grid-column: auto !important; }

            .main-btn { padding: 18px !important; font-size: 1.1rem !important; width: 100%; }
            
            .preset-btns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 5px; height: 100%; width: 100%; }
            .preset-btn { 
                background: #2d2d2d; 
                border: 2px solid #333; 
                color: #ccc; font-size: 0.9rem; 
                padding: 10px 0; 
                border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; font-weight: 800; 
            }
            .preset-btn:hover { border-color: #777; background: #383838; color: #fff; }
            .preset-btn.active { 
                border: 2px solid var(--primary); 
                color: #fff; background: linear-gradient(180deg, rgba(0,230,118,0.1) 0%, rgba(0,230,118,0.2) 100%); 
                box-shadow: 0 4px 12px rgba(0,230,118,0.2); 
            }
        }

        /* [모바일용 스타일] */
        .pc-br { display: none; }
        .ratio-inputs-row { display: flex; gap: 10px; width: 100%; margin-top: 10px; }
        .ratio-select-wrapper { width: 100%; position: relative; }
        .ratio-select { 
            width: 100%; padding: 12px; padding-right: 30px;
            background: #151515; color: #fff; border: 1px solid #333; border-radius: 10px; 
            font-size: 1rem; font-weight: bold; cursor: pointer; outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 24px;
        }

        @media (max-width: 1023px) {
            /* [수정 시작] 모바일 컨트롤 박스 재설계 */
            .pc-controls-wrapper { 
                display: flex !important; 
                flex-direction: column !important; /* 세로 배치 */
                width: 50% !important; /* 너비 절반 */
                background: var(--surface); 
                padding: 15px; 
                border-radius: var(--radius-md); 
                border: 1px solid var(--border); 
                margin-bottom: 15px; 
                align-items: center; /* 중앙 정렬 */
                gap: 12px;
                margin-right: auto; /* 왼쪽 정렬 */
            }

            .btn-group-vertical { 
                display: flex; 
                flex-direction: row; 
                gap: 12px; 
                align-items: center; 
                justify-content: center;
                border-right: none !important; /* 구분선 제거 */
                padding-right: 0 !important;
                width: 100%;
            }

            .chk-group-vertical { 
                display: flex;
                flex-direction: column; /* 세로 정렬 */
                gap: 8px;
                padding-left: 0 !important;
                align-items: flex-start;
                margin: 0;
                background: transparent;
                border: none;
                width: auto;
            }
            /* [수정 끝] */

            #splitPanel { grid-template-columns: 1fr 1fr 1fr !important; gap: 10px; }
            #splitPanel .input-group:last-child { grid-column: 1 / -1 !important; margin-top: 5px; }

            .tab-attach { 
                width: 44px; height: 44px; border-radius: 12px; 
                display: flex; justify-content: center; align-items: center; 
                font-weight: 900; font-size: 1.6rem; 
                padding-bottom: 2px;
                background: #2a2a2a;
            }
            .tab-delete { 
                width: 44px; height: 44px; border-radius: 12px; 
                display: flex; justify-content: center; align-items: center; 
                font-weight: 900; 
                background: #2a2a2a;
            }
            
            .pc-tab-menu { display: contents; } 
            
            .preset-btn { 
                padding: 15px 0 !important; 
            }
        }

        /* [공통 스타일] */
        .container { background: var(--panel-bg); padding: 2rem; border-radius: var(--radius-lg); box-shadow: 0 20px 60px rgba(0,0,0,0.5); text-align: center; width: 95%; max-width: 620px; border: 1px solid rgba(255,255,255,0.05); z-index: 10; position: relative; margin-top: 5vh; margin-bottom: 2rem; }
        .header-wrap { display: flex; justify-content: center; align-items: center; margin-bottom: 1.2rem; position: relative; width: 100%; }
        @media (min-width: 1024px) { .header-wrap { justify-content: center; } }
        
        h1 { color: var(--primary); margin: 0; font-weight: 900; font-size: 2.4rem; letter-spacing: -0.5px; background: linear-gradient(135deg, #00e676 0%, #69f0ae 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sub-text { color: var(--text-sub); font-size: 1.15rem; margin-bottom: 2rem; font-weight: 500; line-height: 1.5; text-align: center; }
        
        .preview-top-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 8px; padding: 0 2px; }
        .counter-box { font-size: 0.8rem; color: #777; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .counter-box b { color: var(--primary); font-size: 0.9rem; }
        .lang-wrapper { display: flex; align-items: center; gap: 8px; }
        .flag-icon { width: 25px; height: 18px; border-radius: 2px; }
        .lang-select { background: #222; border: 1px solid #444; color: #888; font-size: 0.9rem; font-weight: bold; padding: 3px 8px; border-radius: 6px; cursor: pointer; }

        #previewContainer { width: 100%; height: 340px; background: #000; border-radius: var(--radius-md); margin-bottom: 1.5rem; border: 1px solid #333; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        #previewCanvas { max-width: 100%; max-height: 100%; object-fit: contain; cursor: crosshair; position: relative; z-index: 2; }
        #guideText { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #555; z-index: 1; pointer-events: none; padding: 20px; }
        #guideText .main-guide { font-size: 1.2rem; font-weight: 700; margin-bottom: 12px; color: #777; }
        #guideText .sub-guide { font-size: 0.85rem; line-height: 1.6; color: #555; }

        .tab-menu { display: flex; align-items: center; gap: 4px; margin-bottom: 1.5rem; padding: 4px; background: #151515; border-radius: 12px; border: 1px solid #2a2a2a; }
        .tab-btn { flex: 1; background: transparent; border: none; color: #666; font-size: 0.95rem; font-weight: 700; cursor: pointer; padding: 10px; border-radius: 8px; transition: all 0.2s ease; }
        .tab-btn.active { color: #000; background: var(--primary); box-shadow: 0 2px 10px rgba(0, 230, 118, 0.2); }
        
        .tab-attach { background: var(--surface); color: var(--primary); border: 1px solid #333; cursor: pointer; display:flex; justify-content:center; align-items:center;}
        .tab-delete { background: var(--surface); color: var(--danger); border: 1px solid #333; font-size: 0.75rem; cursor: pointer; display:flex; justify-content:center; align-items:center;}

        .chk-label { display: flex; align-items: center; gap: 4px; font-size: 0.95rem; cursor: pointer; color: #ccc; }
        .chk-label input { accent-color: var(--primary); width: 18px; height: 18px; }

        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: var(--surface); padding: 20px; border-radius: var(--radius-md); margin-bottom: 1.5rem; border: 1px solid var(--border); text-align: left; }
        .input-group { display: flex; flex-direction: column; gap: 8px; width: 100%; align-items: center; } 
        label { font-size: 0.85rem; color: #888; font-weight: 700; margin-left: 0; text-align: center; width: 100%; white-space: nowrap; }
        
        /* 입력 숫자 중앙 정렬 */
        .input-num { background: #151515; border: 1px solid #333; color: #fff; padding: 12px 0; border-radius: 10px; font-weight: bold; font-size: 1.1rem; width: 100%; text-align: center; }

        .preset-btns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 5px; height: 100%; }
        .preset-btn { background: #2d2d2d; border: 1px solid #444; color: #ccc; font-size: 0.9rem; padding: 15px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; font-weight: 800; }
        .preset-btn:hover { border-color: #777; background: #383838; color: #fff; }
        .preset-btn.active { border: 2px solid var(--primary); color: #fff; background: linear-gradient(180deg, rgba(0,230,118,0.1) 0%, rgba(0,230,118,0.2) 100%); box-shadow: 0 4px 12px rgba(0,230,118,0.2); }
        .preset-btn span { display: block; }

        .btn-original { background: #333; border: 1px solid #444; color: #fff; font-size: 0.9rem; font-weight: 800; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; height: 100%; }
        .btn-original:hover { border-color: var(--primary); color: var(--primary); }
        .btn-original.active { background: var(--primary); color: #000; border-color: var(--primary); }
        .btn-original:disabled { opacity: 0.3; cursor: not-allowed; }

        .input-wrapper { position: relative; width: 100%; }
        /* 입력칸 패딩 제거하여 완전한 중앙 정렬 */
        .input-wrapper input { padding-right: 0 !important; width: 100%; text-align: center !important; }
        .input-unit { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #888; font-weight: 800; font-size: 0.85rem; pointer-events: none; }

        .action-row { display: flex; flex-direction: column; gap: 12px; margin-bottom: 1.5rem; align-items: stretch; }
        .main-btn { flex: 1; padding: 22px; border-radius: var(--radius-md); border: none; background: linear-gradient(135deg, #00e676, #00c853); color: #000; font-size: 1.25rem; font-weight: 900; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 10px 30px rgba(0,230,118,0.2); }
        .main-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(0,230,118,0.3); }
        
        .donation-btn { flex: 0 0 auto; display: flex; justify-content: center; align-items: center; text-align: center; background: #ffe812; color: #3c1e1e; padding: 12px; border-radius: var(--radius-md); cursor: pointer; border: none; width: 100%; font-weight: 800; font-size: 0.9rem; line-height: 1.4; white-space: pre-wrap; transition: transform 0.2s; }
        .donation-btn:hover { transform: translateY(-2px); }

        .qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 20000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .qr-modal.active { display: flex; animation: fadeIn 0.2s ease-out; }
        .qr-box { background: #fff; padding: 30px; border-radius: 24px; text-align: center; max-width: 340px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        .qr-img { width: 100%; height: auto; display: block; border-radius: 12px; border: 1px solid #eee; }
        .close-qr { margin-top: 20px; padding: 14px 0; width: 100%; background: #222; color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; }
        .prompt-view { background: #111; color: #00e676; padding: 15px; border-radius: 12px; font-family: monospace; font-size: 0.85rem; text-align: left; margin: 15px 0; white-space: pre-wrap; border: 1px solid #333; max-height: 300px; overflow-y: auto; }
        .copy-btn { width: 100%; padding: 12px; background: var(--gem-accent); color: white; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; margin-bottom: 10px; }
        .policy-content { max-height: 60vh; overflow-y: auto; text-align: left; font-size: 0.85rem; color: #333; line-height: 1.6; padding: 10px; background: #f9f9f9; border-radius: 8px; margin-top: 15px; }

        #dropOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); border: 4px dashed var(--primary); display: none; justify-content: center; align-items: center; pointer-events: none; transition: opacity 0.3s; }
        #dropOverlay.active { display: flex; }
        #dropOverlay::after { content: '이미지를 이곳에 놓으세요'; color: var(--primary); font-size: 1.8rem; font-weight: 800; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <div id="dropOverlay"></div> 
    
    <div class="header-wrap">
        <h1>Animo Pixel Master</h1>
    </div>

    <p class="sub-text" data-i18n="sub">화질 저하 없는 제미나이 워터마크 제거<br>고성능 이미지 분할과 이미지 압축</p>

    <div class="dashboard-layout">
        
        <div class="workspace-left">
            <div class="preview-top-bar">
                <div class="counter-box">
                    <span data-i18n="visitors">Today's Visitors</span>
                    <b id="cntVisit">0</b>
                </div>
                <div class="lang-wrapper">
                    <img id="currentFlag" src="https://flagcdn.com/24x18/kr.png" alt="KR" class="flag-icon">
                    <select class="lang-select" onchange="changeLanguage(this.value)">
                        <option value="ko">KO</option>
                        <option value="en">EN</option>
                        <option value="cn">CN</option>
                        <option value="jp">JP</option>
                    </select>
                </div>
            </div>

            <div id="previewContainer">
                <div id="guideText">
                    <div class="main-guide" data-i18n="guide_m">이미지를 이곳에 드래그 하거나<br>+ 버튼을 눌러주세요</div>
                    <div class="sub-guide">
                        <span data-i18n="guide_s">워터마크 삭제는 제미나이만 지원합니다.<br>자동 저장 체크시 드래그만으로 자동 저장됩니다.</span>
                        <div id="mobileGuide" style="color:#00e676; font-weight:bold; margin-top:8px;"></div>
                    </div>
                </div>
                <canvas id="previewCanvas" style="display:none;" 
                    onmousedown="handleStart(event)" onmousemove="handleMove(event)" onmouseup="handleEnd()" onmouseleave="handleEnd()"
                    ontouchstart="handleStart(event)" ontouchmove="handleMove(event)" ontouchend="handleEnd()">
                </canvas>
            </div>
        </div>

        <div class="workspace-right">
            
            <div class="pc-tab-menu tab-menu">
                <button class="tab-btn active" id="pcTabSplit" onclick="switchTab('split')">
                    <span data-i18n="tab_split">이미지 분할</span>
                </button>
                <button class="tab-btn" id="pcTabCrop" onclick="switchTab('crop')">
                    <span data-i18n="tab_crop">이미지 압축</span>
                </button>
                <div class="tab-spacer" style="display:none;"></div>
            </div>

            <div class="tab-menu" style="display:none;"> 
                <button class="tab-btn active" id="mobTabSplit" onclick="switchTab('split')">
                    <span data-i18n="tab_split">이미지 분할</span>
                </button>
                <button class="tab-btn" id="mobTabCrop" onclick="switchTab('crop')">
                    <span data-i18n="tab_crop">이미지 압축</span>
                </button>
            </div>

            <div class="pc-controls-wrapper">
                <div class="btn-group-vertical">
                    <label for="fileInput" class="tab-attach">+</label>
                    <div class="tab-delete" onclick="clearFiles()">Del</div>
                </div>

                <div class="chk-group-vertical top-options">
                    <label class="chk-label"><input type="checkbox" id="wmCheck"><span data-i18n="wm">워터마크 제거</span></label>
                    <label class="chk-label"><input type="checkbox" id="autoCheck"><span data-i18n="auto">자동 저장</span></label>
                    <label class="chk-label" style="display:none;"><input type="checkbox" id="freeCheck" onchange="toggleFreeMode()"><span data-i18n="free">직접 조절</span></label>
                </div>
            </div>

            <div id="splitPanel" class="config-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="input-group"><label data-i18n="row">가로 칸</label><input type="number" id="rowInput" class="input-num" value="1" min="1" oninput="resetGridPositions()"></div>
                <div class="input-group"><label data-i18n="col">세로 칸</label><input type="number" id="colInput" class="input-num" value="1" min="1" oninput="resetGridPositions()"></div>
                <div class="input-group">
                    <label data-i18n="border">테두리(%)</label>
                    <div class="input-wrapper">
                        <input type="number" id="cropInput" class="input-num" value="0.5" step="0.1" oninput="drawVisualizer()">
                        </div>
                </div>
                
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label data-i18n="cut_ratio">이미지 크기</label>
                    <div class="ratio-select-wrapper">
                        <select id="ratioSelectSplit" class="ratio-select" onchange="handleRatioSelect(this, 'split')">
                            <option value="full" data-i18n="full">원본 (자유 변형)</option>
                            <option value="1.777">16:9</option>
                            <option value="0.5625">9:16</option>
                            <option value="1">1:1</option>
                            <option value="custom" data-i18n="custom">직접 입력</option>
                        </select>
                    </div>
                    <div id="customRatioInputSplit" class="ratio-inputs-row" style="display:none;">
                        <input type="number" id="ratioWSplit" class="input-num" value="1" oninput="setRatioFromInput('split')">
                        <input type="number" id="ratioHSplit" class="input-num" value="1" oninput="setRatioFromInput('split')">
                    </div>
                </div>
            </div>

            <div id="cropPanel" class="config-grid" style="display: none;">
                 <div class="input-group" style="grid-column: 1 / -1;">
                    <label data-i18n="target_cap">압축 용량</label>
                    <div class="preset-btns">
                        <button class="preset-btn" id="p500" onclick="setTargetMB(0.5, this)"><span data-i18n="p500">500KB 이하</span></button>
                        <button class="preset-btn" id="p1" onclick="setTargetMB(1.0, this)"><span data-i18n="p1">1MB 이하</span></button>
                        <button class="preset-btn" id="p2" onclick="setTargetMB(2.0, this)"><span data-i18n="p2">2MB 이하</span></button>
                        <button class="preset-btn active" id="p5" onclick="setTargetMB(5.0, this)"><span data-i18n="p5">5MB 이하</span></button>
                    </div>
                </div>

                 <div class="input-group" style="grid-column: 1 / -1;">
                    <label data-i18n="cut_ratio">이미지 크기</label>
                    <div class="ratio-select-wrapper">
                        <select id="ratioSelect" class="ratio-select" onchange="handleRatioSelect(this, 'crop')">
                            <option value="full" data-i18n="full">원본 (자유 변형)</option>
                            <option value="1.777">16:9</option>
                            <option value="0.5625">9:16</option>
                            <option value="1">1:1</option>
                            <option value="custom" data-i18n="custom">직접 입력</option>
                        </select>
                    </div>
                    <div id="customRatioInput" class="ratio-inputs-row" style="display:none;">
                        <input type="number" id="ratioW" class="input-num" value="1" oninput="setRatioFromInput('crop')">
                        <input type="number" id="ratioH" class="input-num" value="1" oninput="setRatioFromInput('crop')">
                    </div>
                </div>
            </div>

            <div class="action-row">
                <button class="main-btn" id="downloadBtn" onclick="executeAction()" data-i18n="down">다운로드</button>
                <div class="donation-btn" onclick="handleDonation()">
                    <span data-i18n="donate_text">도움이 되셨다면<br>아메리카노 한 잔 ☕</span>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/webp,image/gif,image/*" style="display:none;" onchange="handleFiles(this.files)">
</div>

<div id="promptModal" class="qr-modal">
    <div class="qr-box" style="max-width: 500px; background: #1e1e1e; color: white;">
        <h3 id="promptTitle" style="color: var(--gem-accent);">프롬프트 안내</h3>
        <p style="font-size: 0.8rem; color: #888; margin-top: -10px;">이 프롬프트를 제미나이 Gems 설정이나 대화창에 복사해 넣으세요.</p>
        <div class="prompt-view" id="promptText"></div>
        <button class="copy-btn" id="btnCopyPrompt" onclick="copyPrompt()">프롬프트 복사하기</button>
        <button class="close-qr" onclick="closePrompt()" style="background: #333;">닫기</button>
    </div>
</div>

<div id="qrModal" class="qr-modal">
    <div class="qr-box">
        <h3>☕ 카메라로 스캔해주세요</h3>
        <img src="https://github.com/two5220/assets/blob/main/kakao_qr.png?raw=true" alt="KakaoPay QR" class="qr-img">
        <button class="close-qr" onclick="closeQr()">닫기</button>
    </div>
</div>

<div id="policyModal" class="qr-modal">
    <div class="qr-box" style="max-width: 500px;">
        <h3 id="policyTitle">개인정보처리방침</h3>
        <div class="policy-content" id="policyText"></div>
        <button class="close-qr" onclick="closePolicy()">닫기</button>
    </div>
</div>

<script>
    const FIX_X = 64, FIX_Y = 64, MASK_URL = "https://raw.githubusercontent.com/two5220/assets/refs/heads/main/mask.png";
    let maskImg = new Image(), maskData = null, maskW = 0, maskH = 0, previewImg = null, originalFile = null;
    let currentTab = 'split', colPos = [], rowPos = [], gridBox = { x1: 0, y1: 0, x2: 1, y2: 1 }, cropBox = { x: 0, y: 0, w: 1, h: 1 };
    let fixedRatio = 'full', currentTargetMB = 5.0, currentLang = 'ko';
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    let mobileSplitIdx = 0; 
    const MAX_MOBILE_SPLIT = 50; 

    /* [프롬프트 데이터 복구] */
    const prompts = {
        stack: `역할 및 목표:
* 사용자가 제공한 특정 주제나 3가지 개별 프롬프트를 바탕으로 절대적 16:9 가로 비율의 이미지 3장을 수직으로 나열한 단일 레이아웃 이미지를 기획하고 생성한다.
* 각 영역(1구역, 2구역, 3구역)에 대해 일관성 있는 스타일이나 지시된 개별 내용을 충실히 반영한다.
* 하나의 영역의 이미지는 다른 레이아웃 영역을 침범하지 않도록 엄격히 구분하며, 이미지 구분 경계선이나 바깥 테두리가 없는 매끄러운 연결을 지향합니다.
* 생성된 이미지를 크롭할 것이기 때문에 생성가능한 최고해상도로 제공한다.

행동 지침 및 규칙:
1) 입력 처리:
 a) 사용자가 단일 주제만 제공할 경우, 그 주제를 바탕으로 서로 보완적인 3가지 세부 장면을 스스로 구상하여 프롬프트를 생성한다.
 b) 사용자가 3가지의 구체적인 프롬프트를 제공할 경우, 각 프롬프트를 1구역, 2구역, 3구역에 순서대로 배정하여 이미지를 구성한다.

2) 이미지 구성 및 품질 제어:
 a) 결과물은 반드시 가로 16:9 비율의 이미지 3장이 위에서 아래로 이어지는 수직 3단 구성이어야 한다.
 b) 시각적 연속성을 유지하거나 사용자의 의도에 따라 명확히 구분된 3가지 시각 정보를 제공한다.
 c) 최종 결과물은 하나의 이미지 파일 내에 3개의 프레임이 포함된 형태여야 한다.
 d) 이미지 내에 '1구역', '2구역', '3구역'과 같은 텍스트 라벨을 표시하지 않는다.

3) 출력 생성:
 a) 이미지를 생성하기 전, 사용자에게 생성할 3가지 장면에 대한 묘사를 간략히 설명한다.
 b) @DALL-E 또는 적절한 이미지 생성 도구를 사용하여 요청된 레이아웃을 생성한다.

말투 및 톤:
* 전문적이고 창의적인 이미지 제작 도우미의 톤을 유지한다.
* 사용자의 요청 사항을 정확히 이해했음을 알리고, 생성될 이미지의 구성 요소를 간략히 설명한다.
* 간결하고 명확한 한국어를 사용하여 소통한다.`,
        side: `목적 및 목표:
* 사용자가 제공한 주제나 3개의 프롬프트를 바탕으로 세로 비율(9:16) 이미지 3장이 가로로 나란히 배치된 단일 이미지 레이아웃(16:9 가로형)을 구성하는 '세로 비율 3장 레이아웃' 전문가 역할을 수행합니다.
* 단일 주제가 주어지면 그에 맞는 3가지 장면을 스스로 구상하여 일관성 있는 레이아웃을 만듭니다.
* 3개의 개별 프롬프트가 주어지면 각 프롬프트의 내용을 충실히 반영하여 3분할 레이아웃에 표현합니다.
* 하나의 영역의 이미지는 다른 레이아웃 영역을 침범하지 않도록 엄격히 구분하며, 이미지 구분 경계선이나 바깥 테두리가 없는 매끄러운 연결을 지향합니다.
* 생성된 이미지를 크롭할 것이기 때문에 생성가능한 최고해상도로 제공한다.

행동 지침 및 규칙:
1) 이미지 구성 방식:
 a) 생성되는 모든 이미지의 최종 비율은 반드시 16:9 (가로형) 레이아웃이어야 합니다.
 b) 이미지 생성 프롬프트에 'A triptych of three distinct vertical panels', 'Three vertical frames side-by-side', '3-panel layout', 'borderless'와 같은 키워드를 포함하여 세 폭 제단화 형식을 유지합니다.
 c) 각 패널은 서로 다른 내용을 담고 있더라도 전체적으로 조화로운 분위기, 조명, 색감을 유지하여 통일감을 줍니다.
 d) 각 세로 패널 사이의 내용이 섞이지 않도록 하되, 물리적인 선(border)은 생성하지 않도록 지시합니다.

2) 입력 처리:
 a) 사용자가 단일 키워드나 주제만 제공할 경우, 서사적 흐름이나 시각적 대비를 고려한 세 가지 시나리오를 제안하고 레이아웃을 구성합니다.
 b) 사용자가 세 개의 독립적인 프롬프트를 제공할 경우, 이를 왼쪽, 중앙, 오른쪽 섹션에 순서대로 매칭하여 시각화합니다.

3) 상호작용 스타일:
 a) 사용자에게 시각화하고 싶은 테마나 구체적인 세 가지 장면 묘사를 요청하며 대화를 시작합니다. '안녕하세요! 어떤 테마로 3분할 레이아웃 이미지를 만들어 드릴까요?'와 같이 시작하세요.
 b) 결과물이 생성되면 각 패널의 의도와 구성을 설명하고, 레이아웃 비율이나 배치에 대한 피드백을 요청합니다.

전반적인 톤:
* 시각 예술 및 레이아웃 디자인 전문가로서 창의적이고 전문적인 어조를 유지합니다.
* 사용자의 추상적인 아이디어를 구체적인 시각적 프롬프트로 변환하는 데 적극적인 도움을 줍니다.`
    };

    function showPrompt(type) {
        const title = type === 'stack' ? '가로 16:9 (수직 3단) 프롬프트' : '세로 9:16 (가로 3열) 프롬프트';
        document.getElementById('promptTitle').innerText = title;
        document.getElementById('promptText').innerText = prompts[type];
        document.getElementById('promptModal').classList.add('active');
        document.getElementById('btnCopyPrompt').innerText = '프롬프트 복사하기';
    }

    function closePrompt() { document.getElementById('promptModal').classList.remove('active'); }

    function copyPrompt() {
        const text = document.getElementById('promptText').innerText;
        navigator.clipboard.writeText(text).then(() => {
            document.getElementById('btnCopyPrompt').innerText = '✅ 복사 완료!';
            setTimeout(() => { document.getElementById('btnCopyPrompt').innerText = '프롬프트 복사하기'; }, 2000);
        });
    }

    function updateMobileGuide() { if (!isMobile) return; const guide = document.getElementById('mobileGuide'); if (guide) guide.innerHTML = t[currentLang].guide_mobile; }
    const KAKAO_LINK = "https://qr.kakaopay.com/Ej8NXO17Z";
    function handleDonation() { if (isMobile) { window.open(KAKAO_LINK, '_blank'); } else { document.getElementById('qrModal').classList.add('active'); } }
    function closeQr() { document.getElementById('qrModal').classList.remove('active'); }
    
    const flags = { ko: 'kr', en: 'us', cn: 'cn', jp: 'jp', in: 'in' };
    const t = {
        ko: { 
            tab_split: "이미지<br class='pc-br'>분할", tab_crop: "이미지<br class='pc-br'>압축", visitors: "Today's Visitors", wm: "워터마크 제거", auto: "자동 저장", free: "직접 조절", 
            row: "가로 칸", col: "세로 칸", border: "테두리(%)", cut_ratio: "이미지 크기", target_cap: "압축 용량", 
            p500: "500KB 이하", p1: "1MB 이하", p2: "2MB 이하", p5: "5MB 이하", full: "원본 (자유 변형)", custom: "직접 입력",
            down: "다운로드", sub: "화질 저하 없는 제미나이 워터마크 제거<br>고성능 이미지 분할과 이미지 압축", 
            guide_m: "이미지를 이곳에 드래그 하거나<br>+ 버튼을 눌러주세요", guide_s: "워터마크 삭제는 제미나이만 지원합니다.<br>자동 저장 체크시 드래그만으로 자동 저장됩니다.",
            guide_mobile: "모바일은 보안 정책상 번호순으로<br>한 장씩 다운로드해야 합니다.",
            wait: "잠시 기다려주세요.", down_pair: "{n}번 다운로드", down_done_pair: "완료! {n}번 다운로드", all_done: "전체 완료 (다시 시작)",
            donate_text: "도움이 되셨다면<br>아메리카노 한 잔 ☕"
        },
        en: { 
            tab_split: "Image<br class='pc-br'>Split", tab_crop: "Image<br class='pc-br'>Compress", visitors: "Today's Visitors", wm: "Remove Watermark", auto: "Auto Save", free: "Manual Adjust", 
            row: "Horizontal Rows", col: "Vertical Cols", border: "Border(%)", cut_ratio: "Image Ratio", target_cap: "Compression", 
            p500: "Under 500KB", p1: "Under 1MB", p2: "Under 2MB", p5: "Under 5MB", full: "Original (Free)", custom: "Custom Input",
            down: "Download", sub: "Lossless Gemini Watermark Removal<br>High Performance Split & Compress", 
            guide_m: "Drag images here or<br>click the + button", guide_s: "Watermark removal supports Gemini only.<br>Auto-save on drag when 'Auto Save' is checked.",
            guide_mobile: "Due to security policy on mobile,<br>please download sequentially.",
            wait: "Please wait.", down_pair: "{n} Download", down_done_pair: "Done! {n} Download", all_done: "All Done (Restart)",
            donate_text: "If this helped,<br>Buy me an Americano ☕"
        },
        jp: {
            tab_split: "画像<br class='pc-br'>分割", tab_crop: "画像<br class='pc-br'>圧縮", visitors: "今日の訪問者", wm: "透かし削除", auto: "自動保存", free: "手動設定", 
            row: "横の分割数", col: "縦の分割数", border: "余白(%)", cut_ratio: "画像比率", target_cap: "圧縮容量", 
            p500: "500KB以下", p1: "1MB以下", p2: "2MB以下", p5: "5MB以下", full: "元画像 (自由)", custom: "手動入力",
            down: "ダウンロード", sub: "画質劣化なし！Gemini透かし削除<br>高性能な画像分割＆圧縮ツール", 
            guide_m: "画像をドラッグするか<br>＋ボタンを押してください", guide_s: "透かし削除はGemini生成画像のみ対応しています。",
            guide_mobile: "モバイルセキュリティポリシーのため、<br>順番にダウンロードしてください。",
            wait: "お待ちください。", down_pair: "{n} ダウンロード", down_done_pair: "完了！ {n} ダウンロード", all_done: "完了 (再開)",
            donate_text: "お役に立てれば<br>コーヒー一杯を ☕"
        },
        in: {
            tab_split: "इमेज<br class='pc-br'>स्प्लिट", tab_crop: "इमेज<br class='pc-br'>कंप्रेस", visitors: "आज के आगंतुक", wm: "वॉटरमार्क", auto: "ऑटो सेव", free: "मैनुअल सेटिंग", 
            row: "क्षैतिज पंक्तियाँ", col: "लंबवत कॉलम", border: "बॉर्डर(%)", cut_ratio: "इमेज अनुपात", target_cap: "संपीड़न", 
            p500: "500KB से कम", p1: "1MB से कम", p2: "2MB से कम", p5: "5MB से कम", full: "मूल (निःशुल्क)", custom: "मैनुअल",
            down: "डाउनलोड", sub: "बिना क्वालिटी खोए जेमिनी वॉटरमार्क हटाएं<br>हाई-स्पीड इमेज विभाजन और संपीड़न", 
            guide_m: "इमेज यहाँ खींचें या<br>+ बटन दबाएं", guide_s: "वॉटरमार्क हटाना केवल जेमिनी के लिए समर्थित है।",
            guide_mobile: "मोबाइल सुरक्षा नीति के कारण,<br>कृपया क्रमिक रूप से डाउनलोड करें।",
            wait: "कृपया प्रतीक्षा करें।", down_pair: "{n} डाउनलोड", down_done_pair: "हो गया! {n} डाउनलोड", all_done: "सभी हो गया (पुनः आरंभ करें)",
            donate_text: "यदि मदद मिली,<br>कॉफी पिलाएं ☕"
        }
    };
    function changeLanguage(lang) { 
        currentLang = lang; 
        document.querySelectorAll('[data-i18n]').forEach(el => { 
            const key = el.getAttribute('data-i18n'); 
            if(t[lang][key]) el.innerHTML = t[lang][key]; 
        }); 
        updateMobileGuide(); updateButtonText();
        const flagCode = flags[lang] || 'kr'; 
        document.getElementById('currentFlag').src = `https://flagcdn.com/24x18/${flagCode}.png`; 
    }
    window.addEventListener('DOMContentLoaded', updateMobileGuide);
    const todayStr = new Date().toISOString().slice(0, 10);
    const savedDate = localStorage.getItem('animo_date');
    let visitCnt = parseInt(localStorage.getItem('animo_visit') || '0');
    if (savedDate !== todayStr) { visitCnt = 0; localStorage.setItem('animo_date', todayStr); }
    if (!sessionStorage.getItem('session_active')) { visitCnt++; localStorage.setItem('animo_visit', visitCnt); sessionStorage.setItem('session_active', 'true'); }
    document.getElementById('cntVisit').innerText = visitCnt;
    const mainCont = document.getElementById('mainContainer');
    window.addEventListener('dragenter', (e) => { e.preventDefault(); document.getElementById('dropOverlay').classList.add('active'); });
    window.addEventListener('dragover', (e) => { e.preventDefault(); });
    mainCont.addEventListener('dragleave', (e) => { if (e.relatedTarget === null || !mainCont.contains(e.relatedTarget)) document.getElementById('dropOverlay').classList.remove('active'); });
    window.addEventListener('drop', (e) => { e.preventDefault(); document.getElementById('dropOverlay').classList.remove('active'); if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files); });
    maskImg.crossOrigin = "Anonymous";
    maskImg.onload = () => { const c = document.createElement('canvas'); c.width = maskImg.width; c.height = maskImg.height; const ctx = c.getContext('2d'); ctx.drawImage(maskImg, 0, 0); const d = ctx.getImageData(0,0,c.width,c.height).data; let minX = c.width, minY = c.height, maxX = 0, maxY = 0, found = false; for(let y=0; y<c.height; y++){ for(let x=0; x<c.width; x++){ if(d[(y*c.width+x)*4]>15){ minX=Math.min(minX,x); maxX=Math.max(maxX,x); minY=Math.min(minY,y); maxY=Math.max(maxY,y); } } } maskW=maxX-minX+1; maskH=maxY-minY+1; maskData=ctx.getImageData(minX, minY, maskW, maskH).data; };
    maskImg.src = MASK_URL;
    function setTargetMB(mb, btn) { currentTargetMB = mb; document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    
    function toggleFreeMode() { 
        const isFree = document.getElementById('freeCheck').checked; 
        const ratioInput = document.getElementById('ratioInputGroup');
        if(ratioInput) ratioInput.style.display = isFree ? 'flex' : 'none';
        if(currentTab === 'split') { if(!isFree) gridBox = { x1: 0, y1: 0, x2: 1, y2: 1 }; }
        resetGridPositions(); drawVisualizer(); 
    }

    function clearFiles() { previewImg = null; originalFile = null; mobileSplitIdx = 0; updateButtonText(); document.getElementById('previewCanvas').style.display = 'none'; document.getElementById('guideText').style.display = 'flex'; document.getElementById('fileInput').value = ''; }
    
    // [수정: 스위치탭 함수 - ID 충돌 방지]
    function switchTab(tab) { 
        currentTab = tab; 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        
        // PC/Mobile 버튼 모두 Active 처리
        if(tab === 'split') {
            if(document.getElementById('pcTabSplit')) document.getElementById('pcTabSplit').classList.add('active');
            if(document.getElementById('mobTabSplit')) document.getElementById('mobTabSplit').classList.add('active');
        } else {
            if(document.getElementById('pcTabCrop')) document.getElementById('pcTabCrop').classList.add('active');
            if(document.getElementById('mobTabCrop')) document.getElementById('mobTabCrop').classList.add('active');
        }

        document.getElementById('splitPanel').style.display = tab === 'split' ? 'grid' : 'none'; 
        document.getElementById('cropPanel').style.display = tab === 'crop' ? 'grid' : 'none'; 
        
        /* [탭 변경 시 원본 자동 선택] */
        if(tab === 'crop') {
            document.getElementById('ratioSelect').value = 'full';
            handleRatioSelect(document.getElementById('ratioSelect'), 'crop');
        } else {
            // 분할 탭에서도 초기화
            document.getElementById('ratioSelectSplit').value = 'full';
            handleRatioSelect(document.getElementById('ratioSelectSplit'), 'split');
        }

        updateButtonText(); drawVisualizer(); 
    }

    function updateButtonText() { const btn = document.getElementById('downloadBtn'); if (isMobile && currentTab === 'split' && previewImg) { const total = parseInt(document.getElementById('colInput').value) * parseInt(document.getElementById('rowInput').value); if (mobileSplitIdx >= total) btn.innerText = t[currentLang].all_done; else { const txt = (mobileSplitIdx === 0) ? t[currentLang].down_pair : t[currentLang].down_done_pair; btn.innerText = txt.replace('{n}', mobileSplitIdx + 1); } } else btn.innerText = t[currentLang].down; }
    
    /* [비율 셀렉트 핸들러 (분할/압축 공통)] */
    function handleRatioSelect(elem, type) {
        const val = elem.value;
        const customInputId = type === 'split' ? 'customRatioInputSplit' : 'customRatioInput';
        const customInput = document.getElementById(customInputId);
        
        if (val === 'custom') {
            customInput.style.display = 'flex';
            setRatioFromInput(type);
        } else if (val === 'full') {
            customInput.style.display = 'none';
            setFixedRatio('full');
        } else {
            customInput.style.display = 'none';
            setFixedRatio(parseFloat(val));
        }
    }

    function setFixedRatio(mode) { 
        fixedRatio = mode; 
        if(mode === 'full') { cropBox = { x: 0, y: 0, w: 1, h: 1 }; } 
        drawVisualizer(); 
    }

    function setRatioFromInput(type) { 
        const wId = type === 'split' ? 'ratioWSplit' : 'ratioW';
        const hId = type === 'split' ? 'ratioHSplit' : 'ratioH';
        const w = parseFloat(document.getElementById(wId).value), h = parseFloat(document.getElementById(hId).value); 
        if(w > 0 && h > 0) { 
            fixedRatio = w / h; 
            adjustCropToRatio(); 
        } 
    }

    function adjustCropToRatio() { 
        if(!previewImg || !fixedRatio || fixedRatio === 'full') return; 
        let r = fixedRatio; 
        const imgRatio = previewImg.width / previewImg.height; 
        if(r > imgRatio) { cropBox.w = 0.9; cropBox.h = (0.9 * imgRatio) / r; } 
        else { cropBox.h = 0.9; cropBox.w = (0.9 * r) / imgRatio; } 
        cropBox.x = (1 - cropBox.w) / 2; cropBox.y = (1 - cropBox.h) / 2; 
        drawVisualizer(); 
    }

    function resetGridPositions() { const cols = parseInt(document.getElementById('colInput').value), rows = parseInt(document.getElementById('rowInput').value); if (cols * rows > MAX_MOBILE_SPLIT && isMobile) { alert(`모바일 최대 ${MAX_MOBILE_SPLIT}분할 지원.`); document.getElementById('colInput').value = 1; document.getElementById('rowInput').value = 1; return; } colPos = []; rowPos = []; for(let i=1; i<cols; i++) colPos.push(i/cols); for(let i=1; i<rows; i++) rowPos.push(i/rows); mobileSplitIdx = 0; updateButtonText(); drawVisualizer(); }
    async function handleFiles(files) { const valid = Array.from(files).filter(f => f.type.startsWith('image/')); if(!valid.length) return; originalFile = valid[0]; const reader = new FileReader(); reader.onload = (e) => { previewImg = new Image(); previewImg.onload = async () => { document.getElementById('previewCanvas').style.display = 'block'; document.getElementById('guideText').style.display = 'none'; resetGridPositions(); if(document.getElementById('autoCheck').checked) { for(let file of valid.slice(0, 20)) await executeAction(file); } }; previewImg.src = e.target.result; }; reader.readAsDataURL(originalFile); }
    function drawVisualizer() { if(!previewImg) return; const canvas = document.getElementById('previewCanvas'), ctx = canvas.getContext('2d'); canvas.width = previewImg.naturalWidth; canvas.height = previewImg.naturalHeight; ctx.drawImage(previewImg, 0, 0); const cropP = parseFloat(document.getElementById('cropInput').value) / 100; if(currentTab === 'split') { const isFree = false; const x1 = gridBox.x1 * canvas.width, y1 = gridBox.y1 * canvas.height, x2 = gridBox.x2 * canvas.width, y2 = gridBox.y2 * canvas.height, gw = x2 - x1, gh = y2 - y1, fCols = [0, ...colPos, 1], fRows = [0, ...rowPos, 1]; if(isFree) { ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0,0,canvas.width, y1); ctx.fillRect(0,y2,canvas.width, canvas.height-y2); ctx.fillRect(0,y1,x1,y2-y1); ctx.fillRect(x2,y1,canvas.width-x2,y2-y1); const sz = canvas.width / 80; ctx.fillStyle = "#00e676"; ctx.fillRect(x1 - sz/2, y1 - sz/2, sz, sz); ctx.fillRect(x2 - sz/2, y1 - sz/2, sz, sz); ctx.fillRect(x1 - sz/2, y2 - sz/2, sz, sz); ctx.fillRect(x2 - sz/2, y2 - sz/2, sz, sz); } let cellNum = 1; for(let r=0; r < fRows.length - 1; r++) { for(let c=0; c < fCols.length - 1; c++) { const sx = x1 + fCols[c]*gw, sy = y1 + fRows[r]*gh, sw = (fCols[c+1]-fCols[c])*gw, sh = (fRows[r+1]-fRows[r])*gh; const mx = sw * cropP, my = sh * cropP; ctx.strokeStyle = "#00e676"; ctx.lineWidth = canvas.width / 110; ctx.strokeRect(sx + mx, sy + my, sw - mx*2, sh - my*2); const fs = Math.min(sw, sh) * 0.18; ctx.font = `bold ${fs}px Pretendard`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.strokeStyle = "black"; ctx.lineWidth = fs / 10; ctx.strokeText(cellNum, sx + sw/2, sy + sh/2); ctx.fillStyle = "#00e676"; ctx.fillText(cellNum, sx + sw/2, sy + sh/2); cellNum++; } } } else { const cx = cropBox.x * canvas.width, cy = cropBox.y * canvas.height, cw = cropBox.w * canvas.width, ch = cropBox.h * canvas.height; ctx.strokeStyle = "#00e676"; ctx.lineWidth = canvas.width / 110; ctx.strokeRect(cx, cy, cw, ch); } }
    function handleStart(e) {} function handleMove(e) {} function handleEnd() {}
    async function executeAction(targetFile = null) { const fileToUse = targetFile || originalFile; if(!fileToUse) return; const btn = document.getElementById('downloadBtn'), originalText = t[currentLang].down; const targetMB = currentTargetMB, doWM = document.getElementById('wmCheck').checked, cropP = parseFloat(document.getElementById('cropInput').value) / 100; const img = await loadImage(fileToUse), base = fileToUse.name.replace(/\.[^/.]+$/, ""); if(currentTab === 'split') { const temp = document.createElement('canvas'); temp.width = img.width; temp.height = img.height; const tCtx = temp.getContext('2d'); tCtx.drawImage(img, 0, 0); if(doWM && maskData) applyEraser(tCtx, img.width, img.height); const x1 = gridBox.x1*img.width, x2 = gridBox.x2*img.width, y1 = gridBox.y1*img.height, y2 = gridBox.y2*img.height, gw = x2-x1, gh = y2-y1, fCols = [0, ...colPos, 1], fRows = [0, ...rowPos, 1], total = (fRows.length-1) * (fCols.length-1); if (isMobile) { if (mobileSplitIdx >= total) { mobileSplitIdx = 0; updateButtonText(); return; } const r = Math.floor(mobileSplitIdx / (fCols.length-1)), c = mobileSplitIdx % (fCols.length-1); let sx = x1 + fCols[c]*gw, sy = y1 + fRows[r]*gh, sw_p = (fCols[c+1]-fCols[c])*gw, sh_p = (fRows[r+1]-fRows[r])*gh; const mx = sw_p*cropP, my = sh_p*cropP, fw = Math.floor(sw_p-mx*2), fh = Math.floor(sh_p-my*2); const p = document.createElement('canvas'); p.width = fw; p.height = fh; p.getContext('2d').drawImage(temp, sx+mx, sy+my, fw, fh, 0, 0, fw, fh); p.toBlob(blob => save(blob, `${base}_${r+1}-${c+1}.${fileToUse.type.split('/')[1]}`), fileToUse.type, 1.0); mobileSplitIdx++; updateButtonText(); } else { btn.innerText = t[currentLang].wait; for(let r=0; r<fRows.length-1; r++) { for(let c=0; c<fCols.length-1; c++) { let sx = x1 + fCols[c]*gw, sy = y1 + fRows[r]*gh, sw_p = (fCols[c+1]-fCols[c])*gw, sh_p = (fRows[r+1]-fRows[r])*gh; const mx = sw_p*cropP, my = sh_p*cropP, fw = Math.floor(sw_p-mx*2), fh = Math.floor(sh_p-my*2); const p = document.createElement('canvas'); p.width = fw; p.height = fh; p.getContext('2d').drawImage(temp, sx+mx, sy+my, fw, fh, 0, 0, fw, fh); await new Promise(res => { p.toBlob(blob => { save(blob, `${base}_${r+1}-${c+1}.${fileToUse.type.split('/')[1]}`); setTimeout(res, 50); }, fileToUse.type, 1.0); }); } } btn.innerText = originalText; } } else { btn.innerText = t[currentLang].wait; const getBlob = async (q, s) => { const tw = Math.round(img.width * s), th = Math.round(img.height * s), tmp = document.createElement('canvas'); tmp.width = tw; tmp.height = th; const tc = tmp.getContext('2d'); tc.drawImage(img, 0, 0, tw, th); if(doWM && maskData) applyEraser(tc, tw, th); const cw = Math.round(cropBox.w * tw), ch = Math.round(cropBox.h * th), res = document.createElement('canvas'); res.width = cw; res.height = ch; res.getContext('2d').drawImage(tmp, Math.round(cropBox.x * tw), Math.round(cropBox.y * th), cw, ch, 0, 0, cw, ch); return new Promise(r => res.toBlob(b => r(b), 'image/jpeg', q)); }; let s = 1.0, q = 0.95, finalBlob = null; const limit = targetMB * 1024 * 1024, minLimit = limit * 0.95, lQ = 0.05, hQ = 1.0, lS = 0.5, hS = 1.0; let lowQ = lQ, highQ = hQ, lowS = lS, highS = hS; for(let i=0; i<30; i++) { q = (lowQ + highQ) / 2; s = (lowS + highS) / 2; finalBlob = await getBlob(q, s); if(finalBlob.size > limit) { highQ = q; highS = s; } else if(finalBlob.size < minLimit) { lowQ = q; lowS = s; } else break; } save(finalBlob, `${base}_target_${targetMB}MB.jpg`); btn.innerText = originalText; } }
    function applyEraser(ctx, w, h) { const imgData = ctx.getImageData(0,0,w,h), data = imgData.data, sx = w - maskW - FIX_X, sy = h - maskH - FIX_Y; for(let y=0; y<maskH; y++) { for(let x=0; x<maskW; x++) { const tx = sx + x, ty = sy + y; if(tx<0 || ty<0 || tx>=w || ty>=h) continue; const tIdx = (ty * w + tx) * 4, mIdx = (y * maskW + x) * 4, alpha = Math.min(maskData[mIdx]/255, 0.98); if(alpha < 0.05) continue; const f = 1/(1-alpha); for(let k=0; k<3; k++) data[tIdx+k] = Math.max(0, Math.min(255, (data[tIdx+k]-255*alpha)*f)); } } ctx.putImageData(imgData, 0, 0); }
    function save(blob, name) { const a = document.createElement('a'), url = URL.createObjectURL(blob); a.href = url; a.download = name; document.body.appendChild(a); a.click(); setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100); }
    function loadImage(file) { return new Promise(r => { const i = new Image(), url = URL.createObjectURL(file); i.onload = () => { URL.revokeObjectURL(url); r(i); }; i.src = url; }); }
    function openPolicy(type) { document.getElementById('policyTitle').innerText = type === 'privacy' ? '개인정보처리방침' : '이용약관'; document.getElementById('policyText').innerHTML = policies[type]; document.getElementById('policyModal').classList.add('active'); }
    function closePolicy() { document.getElementById('policyModal').classList.remove('active'); }
    const policies = { privacy: `<strong>1. 개인정보 처리 원칙</strong><br>Animo Pixel Master는 사용자의 이미지를 서버로 전송하지 않습니다. 모든 작업은 브라우저 내부에서만 수행됩니다.<br><br><strong>2. 데이터 보관</strong><br>어떠한 이미지 데이터도 수집하거나 저장하지 않습니다.<br><br><strong>3. 광고 및 쿠키</strong><br>애드센스 광고를 통해 사용자 맞춤형 광고가 게재될 수 있으며, 이는 구글의 정책을 따릅니다.`, terms: `<strong>1. 서비스 목적</strong><br>이미지 분할 및 워터마크 제거 기능을 무료로 제공합니다.<br><br><strong>2. 책임의 한계</strong><br>본 도구를 사용해 발생한 결과물에 대한 법적 책임은 사용자에게 있습니다.` };
</script>
</body>
</html>
