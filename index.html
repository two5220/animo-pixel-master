<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animo Pixel Master</title>
    <style>
        /* [디자인 업그레이드: 모던 다크 테마 & 글래스모피즘] */
        :root { 
            --primary: #00e676; 
            --primary-dim: rgba(0, 230, 118, 0.1);
            --bg-dark: #121212; 
            --panel-bg: #1e1e1e; 
            --surface: #252525;
            --border: #333; 
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            --danger: #ff5252;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a3a2a 0%, #121212 60%);
            color: var(--text-main); 
            margin: 0; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow-x: hidden; 
        }
        
        /* 스크롤바 커스텀 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        #dropOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; 
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            border: 4px dashed var(--primary); 
            border-radius: var(--radius-lg);
            display: none; justify-content: center; align-items: center; pointer-events: none;
            transition: opacity 0.3s;
        }
        #dropOverlay.active { display: flex; }
        #dropOverlay::after { 
            content: '이미지를 이곳에 놓으세요'; 
            color: var(--primary); 
            font-size: 1.8rem; 
            font-weight: 800; 
            text-shadow: 0 0 20px rgba(0,230,118,0.4);
        }

        .container { 
            background: var(--panel-bg); 
            padding: 3rem; 
            border-radius: var(--radius-lg); 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); 
            text-align: center; 
            width: 95%; 
            max-width: 620px; 
            border: 1px solid rgba(255,255,255,0.05); 
            z-index: 10; 
            position: relative; 
        }
        
        @media (max-width: 480px) {
            .container { padding: 1.2rem; }
        }
        
        /* 헤더 스타일 */
        .header-wrap { 
            display: flex; justify-content: center; align-items: center; 
            margin-bottom: 2rem; /* 수정: 언어 선택기 공간 확보를 위해 여백 증가 */
            position: relative; width: 100%; 
        }
        h1 { 
            color: var(--primary); margin: 0; font-weight: 900; font-size: 2rem; 
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #00e676 0%, #69f0ae 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .lang-wrapper {
            position: absolute; 
            right: 0;
            bottom: -35px; /* 수정: 타이틀과 겹치지 않도록 아래로 이동 */
            display: flex;
            align-items: center;
            gap: 5px; 
        }

        .flag-icon {
            width: 20px;
            height: 15px;
            border-radius: 2px;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
            object-fit: cover;
        }
        
        .lang-select {
            background: #222; border: 1px solid #444; color: #888; 
            font-size: 0.7rem; font-weight: bold; padding: 2px 5px; 
            border-radius: 6px; cursor: pointer; outline: none;
        }
        .lang-select:hover { color: var(--accent); border-color: var(--accent); }

        .sub-text { 
            color: var(--text-sub); font-size: 0.95rem; margin-bottom: 2rem; font-weight: 500; 
            line-height: 1.5; /* 줄 간격 추가 */
        }
        
        /* 프리뷰 영역 */
        #previewContainer { 
            width: 100%; height: 340px; 
            background: #000; 
            border-radius: var(--radius-md); 
            margin-bottom: 1.5rem; 
            border: 1px solid #333; 
            position: relative; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        #previewCanvas { max-width: 100%; max-height: 100%; object-fit: contain; cursor: crosshair; position: relative; z-index: 2; }
        
        #guideText {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #555; z-index: 1; pointer-events: none; padding: 20px;
            transition: opacity 0.3s;
        }
        #guideText .main-guide { font-size: 1.2rem; font-weight: 700; margin-bottom: 12px; color: #777; }
        #guideText .sub-guide { font-size: 0.85rem; line-height: 1.6; color: #555; }

        /* 탭 메뉴 */
        .tab-menu { 
            display: flex; align-items: center; gap: 4px; margin-bottom: 1.5rem; 
            padding: 4px; background: #151515; border-radius: 12px;
            border: 1px solid #2a2a2a;
        }
        .tab-btn { 
            flex: 1;
            background: transparent; border: none; color: #666; 
            font-size: 0.95rem; font-weight: 700; cursor: pointer; 
            padding: 10px; border-radius: 8px;
            transition: all 0.2s ease;
        }
        .tab-btn.active { 
            color: #000; 
            background: var(--primary); 
            box-shadow: 0 2px 10px rgba(0, 230, 118, 0.2);
        }
        
        .btn-group { display: flex; gap: 10px; align-items: center; }
        
        .tab-attach, .tab-delete { 
            width: 36px; height: 36px; border-radius: 10px; 
            display: flex; justify-content: center; align-items: center; 
            cursor: pointer; font-weight: 900; font-size: 1.1rem; 
            padding: 0; line-height: 1; text-align: center;
        }
        .tab-attach { background: var(--surface); color: var(--primary); border: 1px solid #333; }
        .tab-delete { background: var(--surface); color: var(--danger); border: 1px solid #333; font-size: 0.75rem; font-weight: 800; }

        .counter-box { 
            display: flex; flex-direction: column; justify-content: center; align-items: flex-end; 
            margin-right: 5px; font-size: 0.65rem; color: #777; font-weight: 600; 
            line-height: 1.2;
        }
        .counter-box b { color: var(--primary); font-size: 0.9rem; }

        /* 옵션 영역 */
        .top-options { 
            display: flex; justify-content: center; align-items: center; gap: 15px; 
            margin-bottom: 1.5rem; background: var(--surface); padding: 12px 20px; 
            border-radius: var(--radius-md); flex-wrap: wrap; 
            border: 1px solid var(--border);
        }
        .chk-label { 
            display: flex; align-items: center; gap: 4px; font-size: 0.95rem; 
            cursor: pointer; color: #ccc;
        }
        .chk-label input { accent-color: var(--primary); width: 18px; height: 18px; }

        .config-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; 
            background: var(--surface); padding: 20px; border-radius: var(--radius-md); 
            margin-bottom: 1.5rem; border: 1px solid var(--border); text-align: left; 
        }
        .input-group { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        label { font-size: 0.85rem; color: #888; font-weight: 700; white-space: nowrap; margin-left: 4px; }
        
        .input-num { 
            background: #151515; border: 1px solid #333; color: #fff; 
            padding: 12px; border-radius: 10px; font-weight: bold; font-size: 1.1rem; 
            width: 100%;
        }

        .ratio-btns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 5px; }
        .ratio-btn { 
            background: #333; border: 1px solid transparent; color: #aaa; 
            font-size: 0.85rem; padding: 10px; border-radius: 8px; 
            cursor: pointer; height: 100%;
        }
        .ratio-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 230, 118, 0.05); }
        
        .preset-btns { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 8px; 
            margin-top: 5px;
            height: 100%;
        }
        .preset-btn { 
            background: #2d2d2d;
            border: 1px solid #444; 
            color: #ccc; 
            font-size: 1.15rem; 
            padding: 0; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: all 0.2s; 
            min-height: 68px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            font-weight: 800;
        }
        .preset-btn:hover { border-color: #777; background: #383838; color: #fff; }
        .preset-btn.active { 
            border: 2px solid var(--primary); 
            color: #fff; 
            background: linear-gradient(180deg, rgba(0,230,118,0.1) 0%, rgba(0,230,118,0.2) 100%);
            box-shadow: 0 4px 12px rgba(0,230,118,0.2);
        }
        .preset-btn span { 
            display: block; 
            font-size: 0.75rem; 
            opacity: 0.8; 
            margin-top: 2px; 
            font-weight: 500;
            word-break: keep-all; 
            line-height: 1.1;
        }

        .main-btn { 
            width: 100%; padding: 22px; border-radius: var(--radius-md); border: none; 
            background: linear-gradient(135deg, #00e676, #00c853); 
            color: #000; font-size: 1.25rem; font-weight: 900; 
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; 
            box-shadow: 0 10px 30px rgba(0,230,118,0.2);
        }
        .main-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(0,230,118,0.3); }
        
        .business-box { 
            margin-top: 1.5rem; background: #0f0f0f; border-radius: var(--radius-md); 
            padding: 15px; border: 1px solid #222; 
            text-align: center; color: #555; font-size: 0.85rem; font-weight: 600; 
        }

        .revenue-group {
            margin-top: 1.5rem;
            display: flex; gap: 12px; align-items: stretch; justify-content: center;
            flex-wrap: wrap; 
        }

        .ad-banner {
            flex: 1 1 300px;
            display: flex; justify-content: center; align-items: center;
            background: #000; border-radius: 12px; overflow: hidden;
            min-height: 100px; border: 1px solid #333;
        }

        .donation-btn {
            flex: 0 0 auto; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #ffe812; color: #3c1e1e; 
            padding: 0 24px; border-radius: 12px; cursor: pointer;
            border: none; min-width: 110px;
            box-shadow: 0 4px 15px rgba(255, 232, 18, 0.15);
        }
        .donation-icon { font-size: 1.6rem; margin-bottom: 4px; }
        .donation-text { font-size: 0.85rem; font-weight: 800; line-height: 1.3; }

        .qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 20000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .qr-modal.active { display: flex; animation: fadeIn 0.2s ease-out; }
        .qr-box { background: #fff; padding: 30px; border-radius: 24px; text-align: center; max-width: 340px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .qr-img { width: 100%; height: auto; display: block; border-radius: 12px; border: 1px solid #eee; }
        .close-qr { margin-top: 20px; padding: 14px 0; width: 100%; background: #222; color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <div id="dropOverlay"></div> 
    
    <div class="header-wrap">
        <h1>Animo Pixel Master</h1>
        <div class="lang-wrapper">
            <img id="currentFlag" src="https://flagcdn.com/24x18/kr.png" alt="KR" class="flag-icon">
            <select class="lang-select" onchange="changeLanguage(this.value)">
                <option value="ko">KO</option>
                <option value="en">EN</option>
                <option value="cn">CN</option>
                <option value="jp">JP</option>
            </select>
        </div>
    </div>

    <p class="sub-text" data-i18n="sub">화질 저하 없는 제미나이 워터마크 제거<br>고성능 이미지 분할과 이미지 압축</p>

    <div id="previewContainer">
        <div id="guideText">
            <div class="main-guide" data-i18n="guide_m">이미지를 이곳에 드래그 하거나<br>+ 버튼을 눌러주세요</div>
            <div class="sub-guide" data-i18n="guide_s">
                워터마크 삭제는 제미나이만 지원합니다.<br>
                자동 저장 체크시 드래그만으로 자동 저장됩니다.
            </div>
        </div>
        <canvas id="previewCanvas" style="display:none;" 
            onmousedown="handleStart(event)" onmousemove="handleMove(event)" onmouseup="handleEnd()" onmouseleave="handleEnd()"
            ontouchstart="handleStart(event)" ontouchmove="handleMove(event)" ontouchend="handleEnd()">
        </canvas>
    </div>

    <div class="tab-menu">
        <button class="tab-btn active" id="tabSplit" onclick="switchTab('split')" data-i18n="tab_split">이미지 분할</button>
        <button class="tab-btn" id="tabCrop" onclick="switchTab('crop')" data-i18n="tab_crop">이미지 압축</button>
        <div class="tab-spacer"></div>
        <div class="btn-group">
            <div class="counter-box">
                <span data-i18n="visitors">Today's Visitors</span>
                <b id="cntVisit">0</b>
            </div>
            <div class="tab-delete" onclick="clearFiles()">Del</div>
            <label for="fileInput" class="tab-attach">+</label>
        </div>
    </div>

    <div class="top-options">
        <label class="chk-label" id="wmOption"><input type="checkbox" id="wmCheck"><span data-i18n="wm">워터마크 제거</span></label>
        <label class="chk-label"><input type="checkbox" id="autoCheck"><span data-i18n="auto">자동 저장</span></label>
        <label class="chk-label" id="freeOption"><input type="checkbox" id="freeCheck" onchange="toggleFreeMode()"><span data-i18n="free">직접 조절</span></label>
    </div>

    <div id="splitPanel" class="config-grid" style="grid-template-columns: repeat(3, 1fr);">
        <div class="input-group"><label data-i18n="col">가로 칸</label><input type="number" id="colInput" class="input-num" value="1" min="1" oninput="resetGridPositions()"></div>
        <div class="input-group"><label data-i18n="row">세로 칸</label><input type="number" id="rowInput" class="input-num" value="1" min="1" oninput="resetGridPositions()"></div>
        <div class="input-group"><label data-i18n="border">테두리 자르기(%)</label><input type="number" id="cropInput" class="input-num" value="0.5" step="0.1" oninput="drawVisualizer()"></div>
    </div>

    <div id="cropPanel" class="config-grid" style="display: none;">
        <div class="input-group">
            <label data-i18n="cut_ratio">자르는 비율 선택</label>
            <div class="ratio-btns">
                <button class="ratio-btn active" id="btnFull" onclick="setFixedRatio('full')" data-i18n="full">원본 전체</button>
                <button class="ratio-btn" id="btnFree" onclick="setFixedRatio('free')" data-i18n="free_trans">자유 변형</button>
                <button class="ratio-btn" id="btn16" onclick="setFixedRatio(16/9)">16:9</button>
                <button class="ratio-btn" id="btn9" onclick="setFixedRatio(9/16)">9:16</button>
                <button class="ratio-btn" id="btnCustom" onclick="setFixedRatio('custom')" data-i18n="custom">비율 입력</button>
                <div style="display: flex; gap: 2px;">
                    <input type="number" id="ratioW" class="input-num" value="1" min="1" disabled oninput="setRatioFromInput()" style="padding: 4px; font-size: 0.8rem; text-align: center;">
                    <input type="number" id="ratioH" class="input-num" value="1" min="1" disabled oninput="setRatioFromInput()" style="padding: 4px; font-size: 0.8rem; text-align: center;">
                </div>
            </div>
        </div>
        <div class="input-group">
            <label data-i18n="target_cap">원하는 파일 용량 (자동 맞춤)</label>
            <div class="preset-btns">
                <button class="preset-btn" id="p500" onclick="setTargetMB(0.5, this)"><span data-i18n="p500">500KB 이하</span> <span data-i18n="p500_d">공공기관 제출용</span></button>
                <button class="preset-btn" id="p1" onclick="setTargetMB(1.0, this)"><span data-i18n="p1">1MB 이하</span> <span data-i18n="p1_d">웹사이트 게시용</span></button>
                <button class="preset-btn" id="p2" onclick="setTargetMB(2.0, this)"><span data-i18n="p2">2MB 이하</span> <span data-i18n="p2_d">블로그/SNS용</span></button>
                <button class="preset-btn active" id="p5" onclick="setTargetMB(5.0, this)"><span data-i18n="p5">5MB 이하</span> <span data-i18n="p5_d">고화질 보관용</span></button>
            </div>
        </div>
    </div>

    <button class="main-btn" onclick="executeAction()" data-i18n="down">다운로드</button>
    <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/webp,image/gif,image/*" style="display:none;" onchange="handleFiles(this.files)">

    <div class="revenue-group">
        <div class="ad-banner">
            <script src="https://ads-partners.coupang.com/g.js"></script>
            <script>new PartnersCoupang.G({"id":944285,"template":"carousel","trackingCode":"AF6557483","width":"320","height":"100","tsource":""});</script>
        </div>
        <div class="donation-btn" onclick="handleDonation()">
            <span class="donation-icon">☕</span>
            <span class="donation-text">개발자에게<br>커피 쏘기</span>
        </div>
    </div>

    <div class="business-box"><span data-i18n="business">비지니스 문의</span> two5200@gmail.com</div>
</div>

<div id="qrModal" class="qr-modal">
    <div class="qr-box">
        <h3>☕ 카메라로 스캔해주세요</h3>
        <img src="https://github.com/two5220/assets/blob/main/kakao_qr.png?raw=true" alt="KakaoPay QR" class="qr-img">
        <button class="close-qr" onclick="closeQr()">닫기</button>
    </div>
</div>

<script>
    const FIX_X = 64, FIX_Y = 64, MASK_URL = "https://raw.githubusercontent.com/two5220/assets/refs/heads/main/mask.png";
    let maskImg = new Image(), maskData = null, maskW = 0, maskH = 0, previewImg = null, originalFile = null, originalType = 'image/jpeg';
    let currentTab = 'split', colPos = [], rowPos = [], gridBox = { x1: 0, y1: 0, x2: 1, y2: 1 }, cropBox = { x: 0, y: 0, w: 1, h: 1 };
    let fixedRatio = 'full', splitRatioSetting = 'free', draggingIdx = -1, draggingType = null, currentTargetMB = 5.0, dragStartGrid = null;

    const KAKAO_LINK = "https://qr.kakaopay.com/Ej8NXO17Z";
    function handleDonation() { const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent); if (isMobile) { window.open(KAKAO_LINK, '_blank'); } else { document.getElementById('qrModal').classList.add('active'); } }
    function closeQr() { document.getElementById('qrModal').classList.remove('active'); }

    let currentLang = 'ko';
    const flags = { ko: 'kr', en: 'us', cn: 'cn', jp: 'jp' };
    const t = {
        // 수정: 모바일 텍스트 줄바꿈 반영
        ko: { business: "비지니스 문의", sub: "화질 저하 없는 제미나이 워터마크 제거<br>고성능 이미지 분할과 이미지 압축", guide_m: "이미지를 이곳에 드래그 하거나<br>+ 버튼을 눌러주세요", guide_s: "워터마크 삭제는 제미나이만 지원합니다.<br>자동 저장 체크시 드래그만으로 자동 저장됩니다.", tab_split: "이미지 분할", tab_crop: "이미지 압축", visitors: "Today's Visitors", auto: "자동 저장", wm: "워터마크 제거", free: "직접 조절", ratio_free: "비율 자유", col: "가로 칸", row: "세로 칸", border: "테두리 자르기(%)", cut_ratio: "자르는 비율 선택", full: "원본 전체", free_trans: "자유 변형", custom: "비율 입력", target_cap: "원하는 파일 용량 (자동 맞춤)", p500: "500KB 이하", p500_d: "공공기관 제출용", p1: "1MB 이하", p1_d: "웹사이트 게시용", p2: "2MB 이하", p2_d: "블로그/SNS용", p5: "5MB 이하", p5_d: "고화질 보관용", down: "다운로드", wait: "잠시 기다려주세요." },
        en: { business: "Business Inquiry", sub: "Lossless Gemini Watermark Removal · Image Split · Compress", guide_m: "Drag images here or<br>click the + button", guide_s: "Watermark removal supports Gemini only.<br>Auto-save on drag when 'Auto Save' is checked.", tab_split: "Image Split", tab_crop: "Compress", visitors: "Today's Visitors", auto: "Auto Save", wm: "Remove Watermark", free: "Draw Lines", ratio_free: "Free Ratio", col: "Columns", row: "Rows", border: "Border Crop(%)", cut_ratio: "Select Crop Ratio", full: "Full Original", free_trans: "Free Transform", custom: "Custom Input", target_cap: "Target File Size (Auto)", p500: "Under 500KB", p500_d: "For Public Inst.", p1: "Under 1MB", p1_d: "For Web Post", p2: "Under 2MB", p2_d: "For Blog/SNS", p5: "Under 5MB", p5_d: "High Quality", down: "Download", wait: "Please wait." },
        cn: { business: "商务咨询", sub: "无损 Gemini 水印去除 · 图片分割 · 压缩", guide_m: "拖放图片到此处或<br>点击 + 按钮", guide_s: "水印去除仅支持 Gemini。<br>勾选自动开始时，拖放即可自动保存。", tab_split: "图片分割", tab_crop: "容量压缩", visitors: "今日访客", auto: "自动开始", wm: "去除水印", free: "手动划线", ratio_free: "自由比例", col: "列数", row: "行数", border: "边框裁剪(%)", cut_ratio: "裁剪比例", full: "原始全图", free_trans: "自由变换", custom: "自定义输入", target_cap: "目标文件大小 (自动)", p500: "500KB 以下", p500_d: "公共机构提交用", p1: "1MB 以下", p1_d: "网站发布用", p2: "2MB 以下", p2_d: "博客/社交媒体用", p5: "5MB 以下", p5_d: "高画质保存用", down: "下载", wait: "请稍候。" },
        jp: { business: "ビジネスのお問い合わせ", sub: "画質劣化なしGemini透かし削除 · 画像分割 · 容量削減", guide_m: "画像をここにドラッグするか<br>+ ボタンを押してください", guide_s: "透かし削除はGeminiのみ対応しています。<br>自動開始にチェックを入れると、ドラッグするだけで自動保存されます。", tab_split: "画像分割", tab_crop: "容量削減", visitors: "今日の訪問者", auto: "自動開始", wm: "透かし削除", free: "手動ライン描画", ratio_free: "比率自由", col: "横のマス", row: "縦のマス", border: "枠のカット(%)", cut_ratio: "切り取り比率", full: "オリジナル全体", free_trans: "自由変形", custom: "比率入力", target_cap: "目標ファイル容量 (自動)", p500: "500KB 以下", p500_d: "公적기관제출용", p1: "1MB 이하", p1_d: "ウェブ사이트掲載用", p2: "2MB 이하", p2_d: "ブログ/SNS用", p5: "5MB 이하", p5_d: "高画質保管용", down: "ダウンロード", wait: "お待ちください。" }
    };

    function changeLanguage(lang) { currentLang = lang; document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(t[lang][key]) el.innerHTML = t[lang][key]; }); const flagCode = flags[lang] || 'kr'; document.getElementById('currentFlag').src = `https://flagcdn.com/24x18/${flagCode}.png`; }
    const todayStr = new Date().toISOString().slice(0, 10);
    const savedDate = localStorage.getItem('animo_date');
    let visitCnt = parseInt(localStorage.getItem('animo_visit') || '0');
    if (savedDate !== todayStr) { visitCnt = 0; localStorage.setItem('animo_date', todayStr); }
    if (!sessionStorage.getItem('session_active')) { visitCnt++; localStorage.setItem('animo_visit', visitCnt); sessionStorage.setItem('session_active', 'true'); }
    document.getElementById('cntVisit').innerText = visitCnt;
    const mainCont = document.getElementById('mainContainer');
    window.addEventListener('dragenter', (e) => { e.preventDefault(); document.getElementById('dropOverlay').classList.add('active'); });
    window.addEventListener('dragover', (e) => { e.preventDefault(); });
    mainCont.addEventListener('dragleave', (e) => { if (e.relatedTarget === null || !mainCont.contains(e.relatedTarget)) document.getElementById('dropOverlay').classList.remove('active'); });
    window.addEventListener('drop', (e) => { e.preventDefault(); document.getElementById('dropOverlay').classList.remove('active'); if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files); });
    maskImg.crossOrigin = "Anonymous";
    maskImg.onload = () => { const c = document.createElement('canvas'); c.width = maskImg.width; c.height = maskImg.height; const ctx = c.getContext('2d'); ctx.drawImage(maskImg, 0, 0); const d = ctx.getImageData(0,0,c.width,c.height).data; let minX = c.width, minY = c.height, maxX = 0, maxY = 0, found = false; for(let y=0; y<c.height; y++){ for(let x=0; x<c.width; x++){ const i = (y*c.width + x)*4; if(d[i]>15){ if(x<minX) minX = x; if(x>maxX) maxX = x; if(y<minY) minY = y; if(y>maxY) maxY = y; found = true; } } } if(found){ maskW = maxX-minX+1; maskH = maxY-minY+1; maskData = ctx.getImageData(minX, minY, maskW, maskH).data; } };
    maskImg.src = MASK_URL;
    function setTargetMB(mb, btn) { currentTargetMB = mb; document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    
    // 수정: 직접 조절 체크 해제 시 입력창(splitPanel)이 사라지는 버그 수정 (display none 제거)
    function toggleFreeMode() { 
        const isFree = document.getElementById('freeCheck').checked; 
        if(!isFree) gridBox = { x1: 0, y1: 0, x2: 1, y2: 1 }; 
        resetGridPositions(); 
        drawVisualizer(); 
    }
    
    function setSplitRatio(r) { splitRatioSetting = r; document.querySelectorAll('.r-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); drawVisualizer(); }
    function clearFiles() { previewImg = null; originalFile = null; document.getElementById('previewCanvas').style.display = 'none'; document.getElementById('guideText').style.display = 'flex'; document.getElementById('fileInput').value = ''; }
    
    // 수정: 탭 전환 시 splitPanel 강제 표시 보장
    function switchTab(tab) { 
        currentTab = tab; 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById(tab === 'split' ? 'tabSplit' : 'tabCrop').classList.add('active'); 
        document.getElementById('splitPanel').style.display = tab === 'split' ? 'grid' : 'none'; 
        document.getElementById('cropPanel').style.display = tab === 'crop' ? 'grid' : 'none'; 
        document.getElementById('freeOption').style.display = tab === 'split' ? 'flex' : 'none'; 
        document.getElementById('wmOption').style.display = tab === 'split' ? 'flex' : 'none'; 
        if(tab === 'split') drawVisualizer(); 
    }
    
    function setFixedRatio(mode) { fixedRatio = mode; document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active')); const rw = document.getElementById('ratioW'), rh = document.getElementById('ratioH'); rw.disabled = (mode !== 'custom'); rh.disabled = (mode !== 'custom'); if(mode === 'free') document.getElementById('btnFree').classList.add('active'); else if(mode === 'full') { document.getElementById('btnFull').classList.add('active'); cropBox = { x: 0, y: 0, w: 1, h: 1 }; } else if(mode === 'custom') { document.getElementById('btnCustom').classList.add('active'); } else if(typeof mode === 'number') { if(mode === 1) document.getElementById('btnCustom').classList.add('active'); else if(mode > 1) document.getElementById('btn16').classList.add('active'); else document.getElementById('btn9').classList.add('active'); } if(mode !== 'full') adjustCropToRatio(); else drawVisualizer(); }
    function setRatioFromInput() { const w = parseFloat(document.getElementById('ratioW').value), h = parseFloat(document.getElementById('ratioH').value); if(w > 0 && h > 0) { fixedRatio = w / h; adjustCropToRatio(); } }
    function adjustCropToRatio() { if(!previewImg || fixedRatio === 'free' || fixedRatio === 'full') { drawVisualizer(); return; } let r = 1; if(fixedRatio === 'custom') { const w = parseFloat(document.getElementById('ratioW').value) || 1; const h = parseFloat(document.getElementById('ratioH').value) || 1; r = w / h; } else { r = (typeof fixedRatio === 'number') ? fixedRatio : 1; } const imgRatio = previewImg.width / previewImg.height; if(r > imgRatio) { cropBox.w = 0.9; cropBox.h = (0.9 * imgRatio) / r; } else { cropBox.h = 0.9; cropBox.w = (0.9 * r) / imgRatio; } cropBox.x = (1 - cropBox.w) / 2; cropBox.y = (1 - cropBox.h) / 2; drawVisualizer(); }
    function resetGridPositions() { const rows = parseInt(document.getElementById('colInput').value); const cols = parseInt(document.getElementById('rowInput').value); colPos = []; rowPos = []; for(let i=1; i<cols; i++) colPos.push(i/cols); for(let i=1; i<rows; i++) rowPos.push(i/rows); drawVisualizer(); }
    async function handleFiles(files) { const valid = Array.from(files).filter(f => f.type.startsWith('image/')); if(!valid.length) return; originalFile = valid[0]; originalType = originalFile.type; const reader = new FileReader(); reader.onload = (e) => { previewImg = new Image(); previewImg.onload = async () => { document.getElementById('previewCanvas').style.display = 'block'; document.getElementById('guideText').style.display = 'none'; resetGridPositions(); if(document.getElementById('autoCheck').checked) { for(let file of valid.slice(0, 20)) { await executeAction(file); } } }; previewImg.src = e.target.result; }; reader.readAsDataURL(originalFile); }
    function drawVisualizer() { if(!previewImg) return; const canvas = document.getElementById('previewCanvas'), ctx = canvas.getContext('2d'); canvas.width = previewImg.naturalWidth; canvas.height = previewImg.naturalHeight; ctx.drawImage(previewImg, 0, 0); const cropP = parseFloat(document.getElementById('cropInput').value) / 100; if(currentTab === 'split') { const isFree = document.getElementById('freeCheck').checked; const x1 = gridBox.x1 * canvas.width, y1 = gridBox.y1 * canvas.height, x2 = gridBox.x2 * canvas.width, y2 = gridBox.y2 * canvas.height, gw = x2 - x1, gh = y2 - y1; const fCols = [0, ...colPos, 1], fRows = [0, ...rowPos, 1]; if(isFree) { ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0,0,canvas.width, y1); ctx.fillRect(0,y2,canvas.width, canvas.height-y2); ctx.fillRect(0,y1,x1,y2-y1); ctx.fillRect(x2,y1,canvas.width-x2,y2-y1); } for(let r=0; r < fRows.length - 1; r++) { for(let c=0; c < fCols.length - 1; c++) { const sx = x1 + fCols[c]*gw, sy = y1 + fRows[r]*gh, sw = (fCols[c+1]-fCols[c])*gw, sh = (fRows[r+1]-fRows[r])*gh; let fw = sw, fh = sh, fx = sx, fy = sy; if(isFree && typeof splitRatioSetting === 'number') { if(sw/sh > splitRatioSetting) { fw = sh * splitRatioSetting; fx = sx + (sw-fw)/2; } else { fh = sw / splitRatioSetting; fy = sy + (sh-fh)/2; } } const mx = fw * cropP, my = fh * cropP; ctx.strokeStyle = "#00e676"; ctx.lineWidth = canvas.width / 110; ctx.strokeRect(fx + mx, fy + my, fw - mx*2, fh - my*2); } } } else { const cx = cropBox.x * canvas.width, cy = cropBox.y * canvas.height, cw = cropBox.w * canvas.width, ch = cropBox.h * canvas.height; ctx.strokeStyle = "#00e676"; ctx.lineWidth = canvas.width / 110; ctx.strokeRect(cx, cy, cw, ch); } }
    function handleStart(e) { if(!previewImg) return; const rect = e.target.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const mx = (clientX - rect.left) / rect.width, my = (clientY - rect.top) / rect.height, tol = 0.04; if(currentTab === 'split' && document.getElementById('freeCheck').checked) { if(Math.abs(mx - gridBox.x1) < tol) { draggingType = 'bound-x1'; return; } if(Math.abs(mx - gridBox.x2) < tol) { draggingType = 'bound-x2'; return; } if(Math.abs(my - gridBox.y1) < tol) { draggingType = 'bound-y1'; return; } if(Math.abs(my - gridBox.y2) < tol) { draggingType = 'bound-y2'; return; } colPos.forEach((p, i) => { if(Math.abs(mx - (gridBox.x1 + p*(gridBox.x2-gridBox.x1))) < tol/2) { draggingIdx = i; draggingType = 'col'; } }); if(draggingIdx === -1) rowPos.forEach((p, i) => { if(Math.abs(my - (gridBox.y1 + p*(gridBox.y2-gridBox.y1))) < tol/2) { draggingIdx = i; draggingType = 'row'; } }); if(draggingIdx === -1 && draggingType === null && mx > gridBox.x1 && mx < gridBox.x2 && my > gridBox.y1 && my < gridBox.y2) { draggingType = 'move-grid'; draggingIdx = { ox: mx, oy: my }; dragStartGrid = { ...gridBox }; } } else if(currentTab === 'crop') { const hX = cropBox.x + cropBox.w, hY = cropBox.y + cropBox.h; if(Math.abs(mx - hX) < tol && Math.abs(my - hY) < tol) draggingType = 'resize'; else if(mx > cropBox.x && mx < hX && my > cropBox.y && my < hY) { draggingType = 'move'; draggingIdx = { ox: mx - cropBox.x, oy: my - cropBox.y }; } } }
    function handleMove(e) { if(!previewImg || !draggingType) return; if(e.type.startsWith('touch')) e.preventDefault(); const rect = e.target.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const mx = (clientX - rect.left) / rect.width, my = (clientY - rect.top) / rect.height; if(draggingType.startsWith('bound-')) { const side = draggingType.split('-')[1]; gridBox[side] = Math.max(0, Math.min(1, side.includes('x') ? mx : my)); } else if(draggingType === 'col') { colPos[draggingIdx] = Math.max(0.01, Math.min(0.99, (mx - gridBox.x1) / (gridBox.x2 - gridBox.x1))); } else if(draggingType === 'row') { rowPos[draggingIdx] = Math.max(0.01, Math.min(0.99, (my - gridBox.y1) / (gridBox.y2 - gridBox.y1))); } else if(draggingType === 'move-grid') { let dx = mx - draggingIdx.ox, dy = my - draggingIdx.oy; gridBox.x1 = Math.max(0, Math.min(1 - (dragStartGrid.x2-dragStartGrid.x1), dragStartGrid.x1 + dx)); gridBox.x2 = gridBox.x1 + (dragStartGrid.x2-dragStartGrid.x1); gridBox.y1 = Math.max(0, Math.min(1 - (dragStartGrid.y2-dragStartGrid.y1), dragStartGrid.y1 + dy)); gridBox.y2 = gridBox.y1 + (dragStartGrid.y2-dragStartGrid.y1); } else if(draggingType === 'resize') { cropBox.w = Math.max(0.05, mx - cropBox.x); let r = (fixedRatio === 'custom') ? (parseFloat(document.getElementById('ratioW').value) || 1) / (parseFloat(document.getElementById('ratioH').value) || 1) : (typeof fixedRatio === 'number' ? fixedRatio : null); if(r) cropBox.h = (cropBox.w * (previewImg.width/previewImg.height)) / r; else cropBox.h = Math.max(0.05, my - cropBox.y); } else if(draggingType === 'move') { cropBox.x = Math.max(0, Math.min(1 - cropBox.w, mx - draggingIdx.ox)); cropBox.y = Math.max(0, Math.min(1 - cropBox.h, my - draggingIdx.oy)); } drawVisualizer(); }
    function handleEnd() { draggingIdx = -1; draggingType = null; }
    
    // 수정: 다운로드 딜레이 1000ms -> 1500ms로 증가 (삼성인터넷 등 씹힘 방지)
    async function executeAction(targetFile = null) { 
        const fileToUse = targetFile || originalFile; 
        if(!fileToUse) return; 
        const currentFileType = fileToUse.type; 
        const btn = document.querySelector('.main-btn'); 
        const originalText = t[currentLang].down; 
        btn.innerText = t[currentLang].wait; 
        
        const targetMB = currentTargetMB, 
              doWM = document.getElementById('wmCheck').checked, 
              cropP = parseFloat(document.getElementById('cropInput').value) / 100, 
              img = await loadImage(fileToUse), 
              fileNameBase = fileToUse.name.replace(/\.[^/.]+$/, ""); 
              
        const getBlob = async (qual, scal) => { 
            const tw = Math.round(img.width * scal), th = Math.round(img.height * scal); 
            const tmp = document.createElement('canvas'); 
            tmp.width = tw; tmp.height = th; 
            const tc = tmp.getContext('2d'); 
            tc.drawImage(img, 0, 0, tw, th); 
            if(doWM && maskData) applyEraser(tc, tw, th); 
            const cw = Math.round(cropBox.w * tw), ch = Math.round(cropBox.h * th); 
            const res = document.createElement('canvas'); 
            res.width = cw; res.height = ch; 
            res.getContext('2d').drawImage(tmp, Math.round(cropBox.x * tw), Math.round(cropBox.y * th), cw, ch, 0, 0, cw, ch); 
            return new Promise(r => res.toBlob(b => r(b), 'image/jpeg', qual)); 
        }; 
        
        if(currentTab === 'split') { 
            const temp = document.createElement('canvas'); 
            temp.width = img.width; temp.height = img.height; 
            const tCtx = temp.getContext('2d'); 
            tCtx.imageSmoothingEnabled = false; 
            tCtx.drawImage(img, 0, 0); 
            if(doWM && maskData) applyEraser(tCtx, img.width, img.height); 
            const x1 = gridBox.x1*img.width, x2 = gridBox.x2*img.width, y1 = gridBox.y1*img.height, y2 = gridBox.y2*img.height, gw = x2-x1, gh = y2-y1; 
            const fCols = [0, ...colPos, 1], fRows = [0, ...rowPos, 1]; 
            
            for(let r=0; r<fRows.length-1; r++) { 
                for(let c=0; c<fCols.length-1; c++) { 
                    let sx = x1 + fCols[c]*gw, sy = y1 + fRows[r]*gh, sw_p = (fCols[c+1]-fCols[c])*gw, sh_p = (fRows[r+1]-fRows[r])*gh; 
                    if(typeof splitRatioSetting === 'number') { 
                        let fw = sw_p, fh = sh_p; 
                        if(sw_p/sh_p > splitRatioSetting) { fw = sh_p * splitRatioSetting; sx += (sw_p-fw)/2; } 
                        else { fh = sw / splitRatioSetting; sy += (sh_p-fh)/2; } 
                        sw_p = fw; sh_p = fh; 
                    } 
                    const mx = sw_p*cropP, my = sh_p*cropP, fw = Math.floor(sw_p-mx*2), fh = Math.floor(sh_p-my*2); 
                    const p = document.createElement('canvas'); 
                    p.width = fw; p.height = fh; 
                    const pCtx = p.getContext('2d'); 
                    pCtx.imageSmoothingEnabled = false; 
                    pCtx.drawImage(temp, sx+mx, sy+my, fw, fh, 0, 0, fw, fh); 
                    
                    let ext = currentFileType.includes('png') ? 'png' : (currentFileType.includes('webp') ? 'webp' : 'jpg'); 
                    
                    // 삼성 인터넷 다운로드 씹힘 방지: 딜레이를 1.5초로 증가
                    await new Promise(resolve => {
                        p.toBlob(blob => {
                            save(blob, `${fileNameBase}_${r+1}-${c+1}-split.${ext}`);
                            // 모바일 브라우저가 이전 다운로드를 처리할 시간을 충분히 줌 (1500ms)
                            setTimeout(resolve, 1500);
                        }, currentFileType || 'image/jpeg', 1.0);
                    });
                } 
            } 
        } else { 
            let s = 1.0, q = 0.95, finalBlob = null; 
            const limit = targetMB * 1024 * 1024, minLimit = limit * 0.95; 
            let lowQ = 0.05, highQ = 1.0, lowS = 0.5, highS = 1.0; 
            for(let i=0; i<30; i++) { 
                q = (lowQ + highQ) / 2; s = (lowS + highS) / 2; 
                finalBlob = await getBlob(q, s); 
                if(finalBlob.size > limit) { highQ = q; highS = s; } 
                else if(finalBlob.size < minLimit) { lowQ = q; lowS = s; } 
                else break; 
            } 
            save(finalBlob, `${fileNameBase}_target_${targetMB}MB.jpg`); 
        } 
        btn.innerText = originalText; 
    }

    function applyEraser(ctx, w, h) { const imgData = ctx.getImageData(0,0,w,h), data = imgData.data; const sx = w - maskW - FIX_X, sy = h - maskH - FIX_Y; for(let y=0; y<maskH; y++) { for(let x=0; x<maskW; x++) { const tx = sx + x, ty = sy + y; if(tx<0 || ty<0 || tx>=w || ty>=h) continue; const tIdx = (ty * w + tx) * 4, mIdx = (y * maskW + x) * 4, alpha = Math.min(maskData[mIdx]/255, 0.98); if(alpha < 0.05) continue; const f = 1/(1-alpha); for(let k=0; k<3; k++) data[tIdx+k] = Math.max(0, Math.min(255, (data[tIdx+k]-255*alpha)*f)); } } ctx.putImageData(imgData, 0, 0); }
    
    // 수정: 모바일 호환성 강화 (DOM 추가 후 클릭, 타임아웃 증가)
    function save(blob, name) { 
        const a = document.createElement('a'); 
        const url = URL.createObjectURL(blob); 
        a.href = url; 
        a.download = name; 
        // 일부 모바일 브라우저는 DOM에 붙어있지 않으면 클릭을 무시함
        document.body.appendChild(a);
        a.click(); 
        // 클릭 직후 제거하지 않고 약간의 텀을 두고 제거
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100); 
    }
    
    function loadImage(file) { return new Promise(r => { const i = new Image(); const url = URL.createObjectURL(file); i.onload = () => { URL.revokeObjectURL(url); r(i); }; i.src = url; }); }
    function download(c, n, type) { c.toBlob(function(blob) { save(blob, n); }, type || 'image/jpeg', 1.0); }
</script>
</body>
</html>
